<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Watch & Earn PH </title>
<meta name="viewport" content="width=device-width">
<style>
body{margin:0;font-family:Arial;background:#0b0b0b;color:#fff}
.container{max-width:900px;margin:auto;padding:20px;text-align:center}
.box{background:#111;padding:15px;border-radius:10px;margin-bottom:15px}
.green{color:#00ff88}.lock{color:#ff6666}
button{padding:10px 15px;border:none;border-radius:6px;cursor:pointer}
button:disabled{background:#555}
input,select{padding:10px;width:100%;max-width:300px;margin:5px}
.progress{width:100%;height:12px;background:#333;border-radius:10px;overflow:hidden}
.progress div{height:100%;background:#00ff88;width:0}
.card{background:#111;padding:10px;border-radius:8px;margin-bottom:6px;text-align:left}
.hidden{display:none}
iframe{width:100%;max-width:800px;height:450px;border-radius:10px}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
<div class="container">
<div id="login" class="box">
  <h3>Login</h3>
  <input id="username" placeholder="Username">
  <input id="password" type="password" placeholder="Password">
  <button onclick="login()">Login</button>
  <div id="loginMsg" class="lock"></div>
</div>

<div id="userPanel" class="hidden">
  <div class="box">üí∞ Balance: ‚Ç±<span id="balance">0.00</span>
    <div class="progress"><div id="withdrawProgress"></div></div>
    <small>Minimum withdrawal ‚Ç±50</small><br>
    <button id="withdrawBtn" onclick="showWithdraw()" disabled>Withdraw</button>
  </div>

<h2>üé¨ Watch & Earn PH</h2>
<h>BASIC PLAN</h>
  <div id="refBox" class="box">
    <h3>üë• Referrer Username</h3>
    <input id="refUsername">
    <button onclick="saveRef()">Save</button>
    <div id="refMsg" class="green"></div>
  </div>
 <div id="playerArea"></div>
  <div class="progress"><div id="videoProgress"></div></div>
  <div id="timer"></div>
  <div id="earned" class="green"></div>

  <div class="box">
    üéÅ Daily Bonus: <span id="dailyBonus" class="green"></span><br>
    üé¨ Watched today: <span id="watchedCount">0</span>/6<br>
    ‚è≥ Next reset in: <span id="countdown"></span>
  </div>
</div>class="box"><h3>Users</h3><button onclick="addUser()">‚ûï Add User</button><div id="userList"></div></div>
  <div class="box"><h3>Withdrawal Requests</h3><div id="withdrawRequests"></div></div>
</div>

<div id="withdrawModal" class="box hidden">
  <button onclick="confirmWithdraw('GCash')">GCash</button>
</div>

<script>
const supabase = supabase.createClient(
  "https://gfajeswvlfsetoaosbwq.supabase.co‚Äù
  "sb_secret_Q5ZP2
QcJb_QprIILzQiS8A_wo9N0Yso"
);

const VIDEO_POOL=["tUMXTD8STeU","ZspGPko6-1w","JATpLtghZCY","vJ7iZH6ILJM","jGyG5Xty37c"];
const DAILY_LIMIT=6;
let currentUser,role="user",player,ytReady=false;
let dailyVideos=[],videoIndex=0;
let timerInt,countdownInt,uData={};

const today=()=>new Date().toISOString().slice(0,10);
const tomorrow=()=>{let d=new Date();d.setDate(d.getDate()+1);d.setHours(0,0,0,0);return d};
const rand=(a,b)=>+(Math.random()*(b-a)+a).toFixed(2);
const shuffle=a=>{for(let i=a.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};

function onYouTubeIframeAPIReady(){ytReady=true}

async function login(){
  const {data,error}=await supabase.from('users').select('*')
    .eq('username',username.value).eq('password',password.value).single();
  if(error||!data){loginMsg.textContent="Wrong login";return;}
  currentUser=data;role=data.role;
  login.classList.add('hidden');
  if(role==='admin'){adminPanel.classList.remove('hidden');loadUsers();loadWithdrawRequests();}
  else{userPanel.classList.remove('hidden');loadUserData();}
}

async function loadUserData(){
  let {data}=await supabase.from('userdata').select('*').eq('user_id',currentUser.id).single();
  if(!data){
    await supabase.from('userdata').insert({user_id:currentUser.id,total:0,watchedToday:[],dailyVideos:[]});
    return loadUserData();
  }
  uData=data;dailyReset();dailyBonus();render();
}

async function saveUser(){await supabase.from('userdata').update(uData).eq('user_id',currentUser.id)}

function dailyReset(){
  if(uData.lastDate!==today()){
    uData.lastDate=today();uData.watchedToday=[];videoIndex=0;
    dailyVideos=shuffle([...VIDEO_POOL]).slice(0,DAILY_LIMIT);
    uData.dailyVideos=dailyVideos;
    uData.bonusVideo=dailyVideos[Math.floor(Math.random()*dailyVideos.length)];
  }
  dailyVideos=uData.dailyVideos;saveUser();loadVideo();startCountdown();
}

function dailyBonus(){
  if(uData.lastBonus===today()){dailyBonus.textContent="Claimed";return;}
  let b=rand(0.1,5);uData.lastBonus=today();uData.total+=b;saveUser();
  dailyBonus.textContent="‚Ç±"+b;
}

function loadVideo(){
  if(!ytReady){setTimeout(loadVideo,500);return;}
  watchedCount.textContent=uData.watchedToday.length;
  if(uData.watchedToday.length>=DAILY_LIMIT)return;
  playerArea.innerHTML="<div id='player'></div>";
  player=new YT.Player("player",{videoId:dailyVideos[videoIndex],playerVars:{autoplay:1,controls:0},
    events:{onReady:startTimer,onStateChange:e=>{if(e.data===YT.PlayerState.ENDED)reward()}}});
}
function startTimer(){
  let chk=setInterval(()=>{let d=player.getDuration();if(d>0){clearInterval(chk);runTimer(Math.floor(d));}},200);
}
function runTimer(t){
  let total=t;clearInterval(timerInt);
  timerInt=setInterval(()=>{timer.textContent=`‚è± ${Math.floor(t/60)}:${String(t%60).padStart(2,"0")}`;
  videoProgress.style.width=((total-t)/total*100)+"%";t--;if(t<0)clearInterval(timerInt);},1000);
}
async function reward(){
  let r=(dailyVideos[videoIndex]===uData.bonusVideo)?1.99:rand(0.1,1);
  uData.total+=r;uData.watchedToday.push(dailyVideos[videoIndex]);videoIndex++;
  await saveUser();render();earned.textContent="‚Ç±"+r+" earned";setTimeout(loadVideo,1500);
}

function render(){
  balance.textContent=uData.total.toFixed(2);
  withdrawBtn.disabled=uData.total<50;
  withdrawProgress.style.width=Math.min(uData.total/50*100,100)+"%";
}
function showWithdraw(){withdrawModal.classList.remove("hidden")}
async function confirmWithdraw(m){
  await supabase.from('withdrawals').insert({user_id:currentUser.id,amount:uData.total,method:m,status:'pending'});
  uData.total=0;await saveUser();render();withdrawModal.classList.add("hidden");
}

function startCountdown(){
  clearInterval(countdownInt);
  countdownInt=setInterval(()=>{let d=tomorrow()-new Date();
  countdown.textContent=`${Math.floor(d/3600000)}h ${Math.floor(d%3600000/60000)}m ${Math.floor(d%60000/1000)}s`;},1000);
}
/* ADMIN */
async function loadUsers(){
  const {data}=await supabase.from('users').select('*');
  userList.innerHTML=data.map(u=>`
    <div class='card'>
      ${u.username} | ‚Ç±${u.balance||0}<br>
      GCash: <input value='${u.gcash||""}' onchange='updateGcash(${u.id},this.value)'><br>
      Balance: <input type='number' value='${u.balance||0}' onchange='updateBalance(${u.id},this.value)'>
    </div>`).join("");
}
async function updateBalance(id,v){await supabase.from('users').update({balance:v}).eq('id',id)}
async function updateGcash(id,v){await supabase.from('users').update({gcash:v}).eq('id',id)}
async function addUser(){
  let u=prompt("Username");let p=prompt("Password");
  if(!u||!p)return;
  await supabase.from('users').insert({username:u,password:p,role:'user',balance:0});
  loadUsers();
}
async function loadWithdrawRequests(){
  const {data}=await supabase.from('withdrawals').select('*,users(username)');
  withdrawRequests.innerHTML=data.map(w=>`
    <div class='card'>
      ${w.users.username} ‚Ç±${w.amount} ${w.status}<br>
      <button onclick='approve(${w.id})'>Approve</button>
      <button onclick='reject(${w.id})'>Reject</button>
    </div>`).join("");
}
async function approve(id){await supabase.from('withdrawals').update({status:'approved'}).eq('id',id);loadWithdrawRequests()}
async function reject(id){await supabase.from('withdrawals').update({status:'rejected'}).eq('id',id);loadWithdrawRequests()}
</script>
</body>
</html>