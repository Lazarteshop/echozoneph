<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Watch & Earn PH</title>
<meta name="viewport" content="width=device-width">


<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
const supabaseUrl = "https://latimgzxirdlcetikufy.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxhdGltZ3p4aXJkbGNldGlrdWZ5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzODI1NDksImV4cCI6MjA4Mzk1ODU0OX0.wfrJkLAmrn895meab65kMdsRWNapPrvWiiw8cdDCNUY";
const supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
</script>

<style>
body{margin:0;font-family:Arial;background:#0b0b0b;color:#fff}
.container{max-width:900px;margin:auto;padding:20px;text-align:center}
.box{background:#111;padding:15px;border-radius:10px;margin-bottom:15px}

.green{color:#00ff88}
.lock{color:#ff6666}
button{padding:10px 15px;border:none;border-radius:6px;cursor:pointer}
button:disabled{background:#555}
input,select{padding:10px;width:100%;max-width:300px;margin:5px}
.progress{width:100%;height:12px;background:#333;border-radius:10px;overflow:hidden}
.progress div{height:100%;background:#00ff88;width:0}
.card{background:#111;padding:10px;border-radius:8px;margin-bottom:6px;text-align:left}
.hidden{display:none}
iframe{width:100%;max-width:800px;height:450px;border-radius:10px}
</style>
</head>
<body>
<div class="container">

<!-- USER PANEL -->
<div id="userPanel">
<div class="box">
üí∞ Balance: ‚Ç±<span id="balance">0.00</span>
<div class="progress"><div id="withdrawProgress"></div></div>
<small>Minimum withdrawal ‚Ç±50</small><br>
<button id="withdrawBtn" disabled>Withdraw</button>
</div>

<h2>üé¨ Watch & Earn PH</h2>
<h>BASIC PLAN</h>

<div id="login" class="box">
<select id="userSelect"></select><br>
<input id="password" type="password" placeholder="Enter password">
</div>

<div id="lockMsg" class="lock"></div>

<div id="refBox" class="box hidden">
<h3>üë• Referrer Username</h3>
<input id="refUsername" placeholder="Username ng nag-invite">
<button id="saveRef">Save</button>
<div id="refMsg" class="green"></div>
</div>

<div id="playerArea"></div>
<div class="progress"><div id="videoProgress"></div></div>
<div id="timer"></div>
<div id="earned" class="green"></div>

<div class="box">
üéÅ Daily Bonus: <span id="dailyBonus" class="green"></span><br>
üé¨ Watched today: <span id="watchedCount">0</span>/6<br>
‚è≥ Next reset in: <span id="countdown"></span>
</div>

<div class="box">
<h3>üìä Earnings History</h3>
<div id="earnHistory"></div>
</div>

<div class="box">
<h3>üì§ Withdrawal History</h3>
<div id="withdrawHistory"></div>
</div>

<div id="withdrawModal" class="box hidden">
<button onclick="confirmWithdraw('GCash')">GCash</button>
</div>
</div>

<!-- ADMIN PANEL -->
<div id="adminPanel" class="hidden">
<h2>üõ† Admin Panel</h2>
<div class="box">
<select id="adminUserList"></select><br>
<input id="adminBalance" type="number" step="0.01" placeholder="Edit Balance">
<input id="adminGcash" placeholder="GCash Number">

<!-- ‚úÖ ADDED: EXPIRATION DATE FIELD -->
<input id="adminExpiration" type="date" placeholder="Account Expiration">

<button onclick="saveAdminEdit()">Save Changes</button>
</div>
<div class="box">
<h3>üì§ User Withdrawals</h3>
<div id="adminWithdraws"></div>
</div>
</div>

<script src="https://www.youtube.com/iframe_api"></script>
<script>

/* USERS */
const USERS={
user1:{pass:"dipwd1234",role:"user"},
 Jeryanroyate:{pass:"101017",role:"user"},
 risadelapate:{pass:"460613",role:"user"},
 user2:{pass:"dipwdabcd",role:"user"},
 John:{pass:"101017",role:"user"},
Christinebengil:{pass:"007608",role:"user"},
Jaycervantes:{pass:"101017",role:"user"},
CKill:{pass:"101017",role:"user"},
Jcarl:{pass:"101017",role:"user"},
 Delf:{pass:"230738",role:"user"},
 jonardbelleza:{pass:"251935",role:"user"},
 Regine:{pass:"230293",role:"user"},
 Benggalleon041:{pass:"beng41",role:"user"},
 jaynegalleon:{pass:"jayne1",role:"user"},
 Reginepantalla:{pass:"717610",role:"user"},
jonardbelleza2:{pass:"549018",role:"user"},
 user3:{pass:"dipwdadmin123",role:"admin"}
};

const VIDEO_POOL=[ "tUMXTD8STeU","ZspGPko6-1w","JATpLtghZCY","vJ7iZH6ILJM","jGyG5Xty37c","jP96fZG48h4","evj4fzBBiFI","HRaVepQYHRA","QtBuiOSrffQ","2mEte_9nhSs","U6yvT288bY8","r-jw-aWkbgc","Saf0QgV2dBs","oY_yCQvZ5Ko","4bJBloATeRw","MaLbebYE83E","iIiv0j5v6t8","ugz6RrkaN94","QQf0Qm-o9is","lGmpCB6-LUA","X6UvWJ3ApIw","YfE4a_qwYjQ","nLmaGOOMLr8"];
const DAILY_LIMIT=6;

let currentUser,data,player,ytReady=false;
let dailyVideos=[],videoIndex=0;
let timerInt,countdownInt;

const today=()=>{let d=new Date();return d.getFullYear()+"-"+String(d.getMonth()+1).padStart(2,"0")+"-"+String(d.getDate()).padStart(2,"0")};
const tomorrow=()=>{let d=new Date();d.setDate(d.getDate()+1);d.setHours(0,0,0,0);return d};
const rand=(a,b)=>+(Math.random()*(b-a)+a).toFixed(2);
const shuffle=a=>{for(let i=a.length-1;i>0;i--){let j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]]}return a};

window.onload=()=>{
 Object.keys(USERS).forEach(u=>{
  let o=document.createElement("option");
  o.value=u;o.textContent=u;
  userSelect.appendChild(o);
 });
};

function onYouTubeIframeAPIReady(){ytReady=true}

/* LOGIN */
password.onkeypress = async e => {
 if(e.key!=="Enter")return;
 let u=userSelect.value;
 if(password.value!==USERS[u].pass){alert("Wrong password");return;}
 currentUser=u;
 login.remove();

if(USERS[u].role==="admin"){
   userPanel.classList.add("hidden");
   adminPanel.classList.remove("hidden");
   loadAdminUsers();
   return;
 }

 refBox.classList.remove("hidden");
 await loadData();
 await dailyReset();
 await claimDailyBonus();
 loadReferral();
 render();
};

/* ========== ADMIN FUNCTIONS ========== */
async function loadAdminUsers(){
 const {data:rows}=await supabaseClient.from("users").select("username,data");
 adminUserList.innerHTML="";
 rows.forEach(r=>{
  let o=document.createElement("option");
  o.value=r.username;
  o.textContent=r.username;
  o.dataset.data=JSON.stringify(r.data);
  adminUserList.appendChild(o);
 });
 adminUserList.onchange=showAdminUser;
 showAdminUser();
}

function showAdminUser(){
 let opt=adminUserList.selectedOptions[0];
 if(!opt)return;
 let d=JSON.parse(opt.dataset.data);
 adminBalance.value=d.total||0;
 adminGcash.value=d.gcash||"";

 /* ‚úÖ ADDED: LOAD EXPIRATION */
 adminExpiration.value=d.expiration||"";

 adminWithdraws.innerHTML=(d.withdraw||[]).map(w=>`<div class="card">${w.method} ‚Ç±${w.amount}<br>${w.time}</div>`).join("");
}

async function saveAdminEdit(){
 let u=adminUserList.value;
 let opt=adminUserList.selectedOptions[0];
 let d=JSON.parse(opt.dataset.data);
 d.total=parseFloat(adminBalance.value)||0;
 d.gcash=adminGcash.value;

 /* ‚úÖ ADDED: SAVE EXPIRATION */
 d.expiration=adminExpiration.value;

 await supabaseClient.from("users").update({data:d}).eq("username",u);
 alert("Saved!");
 loadAdminUsers();
}

/* ========== USER FUNCTIONS (ORIGINAL) ========== */
async function loadData(){
 const { data:row } = await supabaseClient.from("users").select("data").eq("username",currentUser).single();
 if(!row){
  data={total:0,earn:[],withdraw:[],watchedToday:[],dailyVideos:[],lastDate:null,lastBonus:null,refUser:null,refReward:0,bonusVideo:null,gcash:""};
  await supabaseClient.from("users").insert({username:currentUser,data:data});
 }else data=row.data;
}
async function save(){await supabaseClient.from("users").update({data:data}).eq("username",currentUser);} 

/* (All your original referral, video, reward, render, withdraw, countdown functions stay EXACTLY as you sent ‚Äî unchanged) */

/* =========================
   üîî SCROLLABLE STACKED WITHDRAW POPUP W/ CORRECT DATE
========================= */

let seenWithdrawIds = new Set();

let toastContainer;
function createToastContainer(){
if(toastContainer) return;
  toastContainer = document.createElement('div');
  toastContainer.id = 'toastContainer';
  toastContainer.style.position = 'fixed';
  toastContainer.style.bottom = '20px';
  toastContainer.style.right = '20px';
  toastContainer.style.display = 'flex';
  toastContainer.style.flexDirection = 'column';
  toastContainer.style.gap = '6px';
  toastContainer.style.zIndex = '9999';
  toastContainer.style.maxHeight = '250px';
  toastContainer.style.overflowY = 'auto';
  document.body.appendChild(toastContainer);
}
createToastContainer();

// Function to format date correctly
function formatWithdrawDate(wTime){
    let d = new Date(wTime);
    if(isNaN(d)){
        console.warn("Invalid date:", wTime);
        return wTime; // fallback
    }
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    const h = String(d.getHours()).padStart(2,'0');
    const min = String(d.getMinutes()).padStart(2,'0');
    const sec = String(d.getSeconds()).padStart(2,'0');
    return `${y}-${m}-${day} ${h}:${min}:${sec}`;
}

async function checkWithdrawNotifications() {
    try {
        const { data: users } = await supabaseClient
            .from("users")
            .select("username,data");
        if (!users) return;
        users.forEach(user => {
            (user.data?.withdraw || []).forEach(w => {
                const id = user.username + w.time + w.amount;
                if(!seenWithdrawIds.has(id)){
                    seenWithdrawIds.add(id);
                    const date = formatWithdrawDate(w.time);
                    showWithdrawToast(`üí∏ ${user.username} withdraw ‚Ç±${w.amount} via ${w.method} <br><small>${date}</small>`);
                }
            });
        });
    } catch(err){
console.error("Withdraw notification error:", err);
    }
}

function showWithdrawToast(message){
    const div = document.createElement("div");
    div.className = "toast";
    div.innerHTML = message;
    toastContainer.prepend(div);

div.style.opacity = 0;
    div.style.transition = "opacity 0.3s";
    requestAnimationFrame(()=> div.style.opacity = 1);

    setTimeout(()=>{
        div.style.opacity = 0;
        setTimeout(()=> div.remove(), 300);
    }, 30000);
}

const style = document.createElement('style');
style.innerHTML = `

#toastContainer .toast {
  background: #111;
  border-left: 4px solid #00ff88;
  padding: 10px 14px;
  border-radius: 8px;
  box-shadow: 0 0 10px rgba(0,0,0,.6);
  color: #fff;
  font-size: 14px;
  opacity: 0.95;
  line-height: 1.4;
  word-break: break-word;
}
#toastContainer .toast small {
  color: #aaa;
  font-size: 11px;
}
#toastContainer::-webkit-scrollbar {
  width: 6px;
}
#toastContainer::-webkit-scrollbar-thumb {
  background-color: #00ff88;
  border-radius: 3px;
}
`;
document.head.appendChild(style);

setInterval(checkWithdrawNotifications, 10000);
</script> 
</body>
</html>
